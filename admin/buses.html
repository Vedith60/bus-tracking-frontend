<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buses - Bus Tracking System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <!-- Mobile Menu Button -->
    <div class="hamburger md:hidden fixed top-4 left-4 z-50">
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <!-- Overlay for mobile menu -->
    <div class="overlay" id="mobileOverlay"></div>
    
    <!-- Sidebar -->
    <div class="flex">
        <div class="w-64 bg-blue-800 text-white min-h-screen sidebar" id="sidebar">
            <div class="p-6">
                <h1 class="text-2xl font-bold">Bus Tracker</h1>
                <p class="text-blue-200 text-sm">Admin Panel</p>
            </div>
            <nav class="mt-8">
                <a href="dashboard.html" class="nav-link text-blue-100 hover:bg-blue-700 hover:text-white block py-3 px-6 border-l-4 border-transparent">
                    <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                </a>
                <a href="#" class="nav-link active bg-blue-700 text-white block py-3 px-6 border-l-4 border-white">
                    <i class="fas fa-bus mr-3"></i>Buses
                </a>
                <a href="routes.html" class="nav-link text-blue-100 hover:bg-blue-700 hover:text-white block py-3 px-6 border-l-4 border-transparent">
                    <i class="fas fa-route mr-3"></i>Routes
                </a>
                <a href="drivers.html" class="nav-link text-blue-100 hover:bg-blue-700 hover:text-white block py-3 px-6 border-l-4 border-transparent">
                    <i class="fas fa-id-card mr-3"></i>Drivers
                </a>
                <a href="supervisors.html" class="nav-link text-blue-100 hover:bg-blue-700 hover:text-white block py-3 px-6 border-l-4 border-transparent">
                    <i class="fas fa-user-tie mr-3"></i>Supervisors
                </a>
                <a href="trips.html" class="nav-link text-blue-100 hover:bg-blue-700 hover:text-white block py-3 px-6 border-l-4 border-transparent">
                    <i class="fas fa-road mr-3"></i>Trips
                </a>
                <a href="maintenance.html" class="nav-link text-blue-100 hover:bg-blue-700 hover:text-white block py-3 px-6 border-l-4 border-transparent">
                    <i class="fas fa-tools mr-3"></i>Maintenance
                </a>
                <a href="reports.html" class="nav-link text-blue-100 hover:bg-blue-700 hover:text-white block py-3 px-6 border-l-4 border-transparent">
                    <i class="fas fa-chart-bar mr-3"></i>Reports
                </a>
                <a href="profile.html" class="nav-link text-blue-100 hover:bg-blue-700 hover:text-white block py-3 px-6 border-l-4 border-transparent">
                    <i class="fas fa-user-circle mr-3"></i>Profile
                </a>
                <a href="#" id="logoutBtn" class="nav-link text-blue-100 hover:bg-blue-700 hover:text-white block py-3 px-6 border-l-4 border-transparent mt-4">
                    <i class="fas fa-sign-out-alt mr-3"></i>Logout
                </a>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 p-8 main-content" id="mainContent">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800">Bus Management</h2>
                <button id="addBusBtn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>Add Bus
                </button>
            </div>
            
            <!-- Search and Filter -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                    <div class="flex-1">
                        <input type="text" id="searchInput" placeholder="Search buses..." 
                               class="w-full md:w-80 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex space-x-2">
                        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Status</option>
                            <option value="valid">Valid Certificates</option>
                            <option value="expiring">Expiring Soon</option>
                            <option value="expired">Expired Certificates</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Buses Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bus Number</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Certificates</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="busesTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading buses...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Bus Modal -->
    <div id="addBusModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Add New Bus</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addBusForm" class="space-y-4">
                <div>
                    <label for="busNumber" class="block text-sm font-medium text-gray-700 mb-1">Bus Number</label>
                    <input type="text" id="busNumber" name="busNumber" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Certificates Section -->
                <div class="border-t pt-4 mt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-medium text-gray-900">Certificates</h4>
                        <button type="button" id="addCertificateBtn" class="bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 text-sm">
                            <i class="fas fa-plus mr-1"></i> Add Certificate
                        </button>
                    </div>
                    
                    <div id="certificatesContainer">
                        <!-- Certificate fields will be added here dynamically -->
                        <div class="certificate-group mb-4 p-4 border rounded-lg" data-index="0">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Certificate Type</label>
                                    <select class="certificate-type w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                        <option value="">Select Type</option>
                                        <option value="RC">RC</option>
                                        <option value="FC Fitness">FC Fitness</option>
                                        <option value="Insurance">Insurance</option>
                                        <option value="Permit">Permit</option>
                                        <option value="RTC Agreement">RTC Agreement</option>
                                        <option value="Pollution">Pollution</option>
                                        <option value="CO">CO</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Certificate Number</label>
                                    <input type="text" class="certificate-number w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required
                                           placeholder="Certificate Number">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                                    <input type="date" class="certificate-expiry w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                            </div>
                            <div class="mt-2 text-right">
                                <button type="button" class="remove-certificate text-red-600 hover:text-red-900 text-sm">
                                    <i class="fas fa-trash mr-1"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Add Bus with Certificates
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Bus Modal -->
    <div id="editBusModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Edit Bus</h3>
                <button id="closeEditModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editBusForm" class="space-y-4">
                <input type="hidden" id="editBusId">
                <div>
                    <label for="editBusNumber" class="block text-sm font-medium text-gray-700 mb-1">Bus Number</label>
                    <input type="text" id="editBusNumber" name="editBusNumber" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Certificates Section -->
                <div class="border-t pt-4 mt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-medium text-gray-900">Certificates</h4>
                        <button type="button" id="addEditCertificateBtn" class="bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 text-sm">
                            <i class="fas fa-plus mr-1"></i> Add Certificate
                        </button>
                    </div>
                    
                    <div id="editCertificatesContainer">
                        <!-- Certificate fields will be populated here -->
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelEditBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Update Bus & Certificates
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Get token and user info from localStorage
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));
        
        // Check if user is logged in and is an admin
        if (!token || !user || user.role !== 'admin') {
            window.location.href = '/frontend/login.html';
        }
        
        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/frontend/login.html';
        });
        
        // Modal functionality
        const addBusModal = document.getElementById('addBusModal');
        const addBusBtn = document.getElementById('addBusBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        
        addBusBtn.addEventListener('click', () => {
            addBusModal.classList.remove('hidden');
        });
        
        closeModalBtn.addEventListener('click', () => {
            addBusModal.classList.add('hidden');
        });
        
        cancelBtn.addEventListener('click', () => {
            addBusModal.classList.add('hidden');
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === addBusModal) {
                addBusModal.classList.add('hidden');
            }
        });
        
        // Function to make authenticated API calls
        async function apiCall(url, options = {}) {
            const fullUrl = url.startsWith('http') ? url : `https://bus-tracking-backend-xemb.onrender.com${url}`;
            const response = await fetch(fullUrl, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            return response;
        }
        
        // Certificate management functionality
        let certificateIndex = 0;
        
        // Add new certificate field
        document.getElementById('addCertificateBtn').addEventListener('click', () => {
            certificateIndex++;
            const certificateGroup = document.createElement('div');
            certificateGroup.className = 'certificate-group mb-4 p-4 border rounded-lg';
            certificateGroup.setAttribute('data-index', certificateIndex);
            certificateGroup.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Certificate Type</label>
                        <select class="certificate-type w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="">Select Type</option>
                            <option value="RC">RC</option>
                            <option value="FC Fitness">FC Fitness</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Permit">Permit</option>
                            <option value="RTC Agreement">RTC Agreement</option>
                            <option value="Pollution">Pollution</option>
                            <option value="CO">CO</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Certificate Number</label>
                        <input type="text" class="certificate-number w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required
                               placeholder="Certificate Number">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                        <input type="date" class="certificate-expiry w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                </div>
                <div class="mt-2 text-right">
                    <button type="button" class="remove-certificate text-red-600 hover:text-red-900 text-sm">
                        <i class="fas fa-trash mr-1"></i> Remove
                    </button>
                </div>
            `;
            document.getElementById('certificatesContainer').appendChild(certificateGroup);
            
            // Add event listener to the remove button
            certificateGroup.querySelector('.remove-certificate').addEventListener('click', function() {
                certificateGroup.remove();
            });
        });
        
        // Add event listener to the initial remove button
        document.querySelector('.remove-certificate').addEventListener('click', function() {
            if (document.querySelectorAll('.certificate-group').length > 1) {
                this.closest('.certificate-group').remove();
            } else {
                alert('At least one certificate is required');
            }
        });
        
        // Load buses
        async function loadBuses() {
            try {
                const response = await apiCall('/api/buses');
                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('busesTableBody');
                    
                    if (data.buses && data.buses.length > 0) {
                        tbody.innerHTML = '';
                        data.buses.forEach(bus => {
                            // Determine certificate status
                            let certStatus = 'Valid';
                            let statusColor = 'bg-green-100 text-green-800';
                            
                            if (bus.certificates && bus.certificates.length > 0) {
                                // Check if any certificate is expired
                                const hasExpired = bus.certificates.some(cert => cert.status === 'Expired');
                                if (hasExpired) {
                                    certStatus = 'Expired';
                                    statusColor = 'bg-red-100 text-red-800';
                                } else {
                                    // Check if any certificate is expiring soon (within 30 days)
                                    const hasExpiring = bus.certificates.some(cert => {
                                        if (cert.status === 'Valid') {
                                            const expiryDate = new Date(cert.expiry_date);
                                            const today = new Date();
                                            const diffTime = expiryDate - today;
                                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                            return diffDays <= 30 && diffDays >= 0;
                                        }
                                        return false;
                                    });
                                    
                                    if (hasExpiring) {
                                        certStatus = 'Expiring Soon';
                                        statusColor = 'bg-yellow-100 text-yellow-800';
                                    }
                                }
                            } else {
                                certStatus = 'No Certificates';
                                statusColor = 'bg-gray-100 text-gray-800';
                            }
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">${bus.bus_number}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-500">${bus.certificates ? bus.certificates.length : 0} certificates</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                        ${certStatus}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <button class="edit-bus text-blue-600 hover:text-blue-900 mr-3" data-id="${bus.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-bus text-red-600 hover:text-red-900" data-id="${bus.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No buses found</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading buses:', error);
                document.getElementById('busesTableBody').innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading buses</td></tr>';
            }
        }
        
        // Add bus form submission
        document.getElementById('addBusForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const busNumber = document.getElementById('busNumber').value;
            
            // Collect certificate data
            const certificates = [];
            const certificateGroups = document.querySelectorAll('.certificate-group');
            
            for (let group of certificateGroups) {
                const certType = group.querySelector('.certificate-type').value;
                const certNumber = group.querySelector('.certificate-number').value;
                const certExpiry = group.querySelector('.certificate-expiry').value;
                
                if (certType && certNumber && certExpiry) {
                    certificates.push({
                        certificate_type: certType,
                        certificate_number: certNumber,
                        expiry_date: certExpiry
                    });
                }
            }
            
            try {
                // First create the bus
                const busResponse = await apiCall('/api/buses', {
                    method: 'POST',
                    body: JSON.stringify({ bus_number: busNumber })
                });
                
                if (busResponse.ok) {
                    const busData = await busResponse.json();
                    const busId = busData.busId;
                    
                    // If certificates were provided, create them
                    if (certificates.length > 0) {
                        for (let cert of certificates) {
                            const certResponse = await apiCall(`/api/buses/${busId}/certificates`, {
                                method: 'POST',
                                body: JSON.stringify({
                                    certificate_type: cert.certificate_type,
                                    certificate_number: cert.certificate_number,
                                    expiry_date: cert.expiry_date
                                })
                            });
                            
                            if (!certResponse.ok) {
                                const certError = await certResponse.json();
                                console.error('Error adding certificate:', certError.message);
                            }
                        }
                    }
                    
                    // Reset form and close modal
                    document.getElementById('addBusForm').reset();
                    addBusModal.classList.add('hidden');
                    
                    // Reload the buses list
                    loadBuses();
                } else {
                    const errorData = await busResponse.json();
                    alert(errorData.message || 'Error adding bus');
                }
            } catch (error) {
                alert('Error adding bus: ' + error.message);
            }
        });
        
        // Edit bus modal functionality
        const editBusModal = document.getElementById('editBusModal');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        
        closeEditModalBtn.addEventListener('click', () => {
            editBusModal.classList.add('hidden');
        });
        
        cancelEditBtn.addEventListener('click', () => {
            editBusModal.classList.add('hidden');
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === editBusModal) {
                editBusModal.classList.add('hidden');
            }
        });
        
        // Edit bus functionality
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-bus')) {
                const busId = e.target.closest('.edit-bus').dataset.id;
                
                try {
                    const response = await apiCall(`/api/buses/${busId}`);
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('editBusId').value = data.bus.id;
                        document.getElementById('editBusNumber').value = data.bus.bus_number;
                        
                        // Populate certificates
                        const certificatesContainer = document.getElementById('editCertificatesContainer');
                        certificatesContainer.innerHTML = '';
                        
                        if (data.bus.certificates && data.bus.certificates.length > 0) {
                            data.bus.certificates.forEach((cert, index) => {
                                const certificateGroup = createCertificateElement(index, cert);
                                certificatesContainer.appendChild(certificateGroup);
                            });
                        } else {
                            // Add one empty certificate field if no certificates exist
                            const certificateGroup = createCertificateElement(0);
                            certificatesContainer.appendChild(certificateGroup);
                        }
                        
                        editBusModal.classList.remove('hidden');
                    } else {
                        alert('Error loading bus data');
                    }
                } catch (error) {
                    alert('Error loading bus data: ' + error.message);
                }
            }
        });
        
        // Function to create certificate element
        function createCertificateElement(index, certData = null) {
            const certificateGroup = document.createElement('div');
            certificateGroup.className = 'certificate-group mb-4 p-4 border rounded-lg';
            certificateGroup.setAttribute('data-index', index);
            
            const certType = certData ? certData.certificate_type : '';
            const certNumber = certData ? certData.certificate_number : '';
            let certExpiry = certData ? certData.expiry_date : '';
            const certId = certData ? certData.id : '';
            
            // Format date for input field if it's in ISO format
            if (certExpiry && typeof certExpiry === 'string') {
                try {
                    // If it's an ISO string, convert to YYYY-MM-DD format
                    if (certExpiry.includes('T')) {
                        const date = new Date(certExpiry);
                        certExpiry = date.toISOString().split('T')[0];
                    }
                } catch (e) {
                    console.error('Error formatting date:', e);
                }
            }
            
            certificateGroup.innerHTML = `
                <input type="hidden" class="certificate-id" value="${certId}">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Certificate Type</label>
                        <select class="certificate-type w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="" ${!certType ? 'selected' : ''}>Select Type</option>
                            <option value="RC" ${certType === 'RC' ? 'selected' : ''}>RC</option>
                            <option value="FC Fitness" ${certType === 'FC Fitness' ? 'selected' : ''}>FC Fitness</option>
                            <option value="Insurance" ${certType === 'Insurance' ? 'selected' : ''}>Insurance</option>
                            <option value="Permit" ${certType === 'Permit' ? 'selected' : ''}>Permit</option>
                            <option value="RTC Agreement" ${certType === 'RTC Agreement' ? 'selected' : ''}>RTC Agreement</option>
                            <option value="Pollution" ${certType === 'Pollution' ? 'selected' : ''}>Pollution</option>
                            <option value="CO" ${certType === 'CO' ? 'selected' : ''}>CO</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Certificate Number</label>
                        <input type="text" class="certificate-number w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="Certificate Number" value="${certNumber}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                        <input type="date" class="certificate-expiry w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${certExpiry}">
                    </div>
                </div>
                <div class="mt-2 text-right">
                    <button type="button" class="remove-certificate text-red-600 hover:text-red-900 text-sm">
                        <i class="fas fa-trash mr-1"></i> Remove
                    </button>
                </div>
            `;
            
            // Add event listener to the remove button
            certificateGroup.querySelector('.remove-certificate').addEventListener('click', function() {
                if (document.querySelectorAll('.certificate-group').length > 1) {
                    certificateGroup.remove();
                } else {
                    alert('At least one certificate field is required');
                }
            });
            
            return certificateGroup;
        }
        
        // Add new certificate field for edit modal
        document.getElementById('addEditCertificateBtn').addEventListener('click', () => {
            const certificatesContainer = document.getElementById('editCertificatesContainer');
            const newIndex = certificatesContainer.children.length;
            const certificateGroup = createCertificateElement(newIndex);
            certificatesContainer.appendChild(certificateGroup);
        });
        
        // Update bus form submission
        document.getElementById('editBusForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const busId = document.getElementById('editBusId').value;
            const busNumber = document.getElementById('editBusNumber').value;
            
            // Collect certificate data
            const certificates = [];
            const certificateGroups = document.querySelectorAll('#editCertificatesContainer .certificate-group');
            
            for (let group of certificateGroups) {
                const certId = group.querySelector('.certificate-id').value || null;
                const certType = group.querySelector('.certificate-type').value || '';
                const certNumber = group.querySelector('.certificate-number').value || '';
                const certExpiry = group.querySelector('.certificate-expiry').value || '';
                
                if (certType && certNumber && certExpiry) {
                    certificates.push({
                        id: certId, // If no ID, it's a new certificate
                        certificate_type: certType.trim(),
                        certificate_number: certNumber.trim(),
                        expiry_date: certExpiry
                    });
                }
            }
            
            try {
                // First update the bus
                const busResponse = await apiCall(`/api/buses/${busId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ bus_number: busNumber })
                });
                
                if (busResponse.ok) {
                    // Process certificates if any were provided
                    if (certificates.length > 0) {
                        for (let cert of certificates) {
                            let certResponse;
                            if (cert.id) {
                                // Update existing certificate
                                const updateData = {
                                    certificate_type: cert.certificate_type || '',
                                    certificate_number: cert.certificate_number || '',
                                    expiry_date: cert.expiry_date || ''
                                };
                                
                                certResponse = await apiCall(`/api/buses/certificates/${cert.id}`, {
                                    method: 'PUT',
                                    body: JSON.stringify(updateData)
                                });
                            } else {
                                // Create new certificate
                                const createData = {
                                    certificate_type: cert.certificate_type || '',
                                    certificate_number: cert.certificate_number || '',
                                    expiry_date: cert.expiry_date || ''
                                };
                                
                                certResponse = await apiCall(`/api/buses/${busId}/certificates`, {
                                    method: 'POST',
                                    body: JSON.stringify(createData)
                                });
                            }
                            
                            if (!certResponse.ok) {
                                const certError = await certResponse.json();
                                console.error('Error updating/adding certificate:', certError.message);
                            }
                        }
                    }
                    
                    editBusModal.classList.add('hidden');
                    loadBuses(); // Reload the buses list
                } else {
                    const errorData = await busResponse.json();
                    alert(errorData.message || 'Error updating bus');
                }
            } catch (error) {
                alert('Error updating bus: ' + error.message);
            }
        });
        
        // Delete bus functionality
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-bus')) {
                const busId = e.target.closest('.delete-bus').dataset.id;
                
                if (confirm('Are you sure you want to delete this bus? This will also delete all associated certificates and trips.')) {
                    try {
                        const response = await apiCall(`/api/buses/${busId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            loadBuses(); // Reload the buses list
                        } else {
                            const errorData = await response.json();
                            alert(errorData.message || 'Error deleting bus');
                        }
                    } catch (error) {
                        alert('Error deleting bus: ' + error.message);
                    }
                }
            }
        });
        
        // Load buses when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadBuses();
        });
        
        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', () => {
            const hamburger = document.querySelector('.hamburger');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.getElementById('mobileOverlay');
            
            if (hamburger) {
                hamburger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebar.classList.toggle('hidden');
                    overlay.classList.toggle('active');
                    
                    // Add class to main content to shift when sidebar is open
                    if (!sidebar.classList.contains('hidden')) {
                        mainContent.classList.add('shifted');
                    } else {
                        mainContent.classList.remove('shifted');
                    }
                });
            }
            
            // Close sidebar when clicking on overlay
            overlay.addEventListener('click', () => {
                sidebar.classList.add('hidden');
                overlay.classList.remove('active');
                mainContent.classList.remove('shifted');
            });
            
            // Close sidebar when clicking outside of it
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 768 && 
                    !sidebar.classList.contains('hidden') && 
                    !e.target.closest('#sidebar') && 
                    !e.target.closest('.hamburger')) {
                    sidebar.classList.add('hidden');
                    overlay.classList.remove('active');
                    mainContent.classList.remove('shifted');
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    sidebar.classList.remove('hidden');
                    overlay.classList.remove('active');
                    mainContent.classList.remove('shifted');
                }
            });
        });
    </script>
</body>
</html>